---
title: "What this Package Does"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DSA5041Project2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(DSA5041PROJ2)
```

# Introduction
  
The goal of this package is to test the NULL hypothesis that the underlying means of two populations are the same. Essentially, we will be using t.test theory to investigate:
$$\begin{align*}
H_0: \mu_x &= \mu_y\\ 
\text{or}\\
H_0: \mu_x -& \mu_y = 0
\end{align*}$$
  
The following package includes a constructor function and two methods attached to generic functions "print" and "plot" to produce a comprehensive summary of the data that tests the NULL hypothesis in question. Among these functions, you will find advanced R techniques like ifelse and ternary statements, maping, ggplot and the %>% (pipe) operator.

## Constructor Function 
  
A constructor function makes an object of a particular OOP class and generates a lot of useful statistical information that methods operate on to produce whatever particulars we need.

### myttest()
  
In general, the constructor myttest investigates the data for evidence in the population variances and an appropriate t-test is made to produce a list.  
  
First, function takes two samples (x and y), "alpha" and "paired" and tests to verify that the entered arguments are valid before proceeding.  
  
Next, the built-in function var.test(x,y) is called to determine if the underlying variances in the population are the same. If the data is paired (i.e. paired = TRUE), there is effectively one sample of differences thus we do not have to compare variances and will proceed to perform a paired t-test on the sample data. Alternatively, when paired = FALSE (i.e. we are handling two sample data) we must extract and analyze the p value from the var test to determine what to do with the NULL hypothesis:
$$\begin{align*}
H_0: \sigma_x^2/\sigma_x^2 = 1\\ 
\end{align*}$$
  
If the p-value is less than 0.05, we reject the NULL, set var.equal to FALSE and a Welch t-test is executed. Otherwise, if the p-value is greater than 0.05, we fail to reject the NULL and accept the NULL as plausible, thus var.equal = TRUE and a standard two sample t-test is carried out.  
  
Next, the constructor myttest creates a list containing the sample data as a data frame; the value of alpha (i.e. the level of significance); summary statistics like the confidence interval and p-value generated from the t-test above; the test type("Paired", "Welch" or "T-test"); and a conclusion of "Y" or "N".  
  
The Y/N" conclusion refers to whether we should reject the NULL mentioned in the introduction:
$$\begin{align*}
H_0: \mu_x -\mu_y = 0
\end{align*}$$
This can be determined by extracting the analyzing the p-value after the appropriate t-tests have been performed on the sample data.  
  
Finally, the constructor function assigns the above list to class "Rttest" and releases it invisibly.

```{r, eval=FALSE}
myttest = function(x, y, alpha, paired = FALSE){
  stopifnot(is.double(x))
  stopifnot(is.double(y))
  stopifnot(is.double(alpha))
  stopifnot(is.logical(paired))

  v = var.test(x,y)
  if(paired == TRUE){
    tp = t.test(x,y,mu = 0, paired = TRUE)
    test_type = "Paired"
  } else if (v$p.value < 0.05){
    tp = t.test(x,y, var.equal = FALSE)
    test_type = "Welch"
  } else if (v$p.value >= 0.05){
    tp = t.test(x,y, var.equal = TRUE)
    test_type = "T-test"
  }

  ans = list(data = data.frame(x = x, y = y), alpha = alpha, ci = tp$conf.int, pvalue = tp$p.value, test_type = test_type, conclusion = ifelse(v$p.value < 0.05, "Y", "N"))
  class(ans) = "Rttest"
  return(ans)
}
```

## Methods
  
A method is a function that is dependent on the class of the object made from the constructor. In the following instances, two methods are attached to to generic functions "print" and "plot". When either "print" or "plot" is called on an s3 object, the function will take the argument and call the correct method according to its assigned class. 
  
### print.Rttest
  
For an object that has been assigned the class "Rttest" via the constructor function myttest(), the generic function print() will behave as follows.    
  
First, print.Rttest examines the argument to ensure it is a list before continuing. Then the function extracts the confidence interval for $\mu_x - \mu_y$ and the test type from the list generated by myttest() and prints them to the command line under the respective headings of \$ci and \$test_type.    
```{r, eval=FALSE}
print.Rttest = function(x, ...){
  stopifnot(is.list(x))
  cat("$ci\n")
  print(x$ci)
  cat("\n$test_type\n")
  print(x$test_type)
}
```


### plot.Rttest
  
For an object that has been assigned the class "Rttest" via the constructor function myttest(), generic function plot() will create boxplots of the data as follows.  

First, plot.Rttest examines the argument to ensure it is a list before proceeding to define the global variable l as NULL (this mitigates any notes from devtools::check()) and extracting the data frame containing x and y from the list produced in the constructor.  
  
If the t-test performed in myttest() was not paired, a side-by-side boxplot is produced of the two samples, x and y, to summarize and compare the two sets.  
  
If the t-test performed in myttest() was paired, a single boxplot of differences is produced and displays an "error bar" inside the boxplot to represent the confidence interval for the difference of means.
```{r, eval=FALSE}
plot.Rttest = function(x,...){
  stopifnot(is.list(x))
  l <- NULL
  df = x$data

  if (x$test_type != "Paired"){
    pop = rep(c("x", "y"), c(30, 30))
    data.frame(pop = pop,l=c(df$x, df$y)) %>%
      ggplot(aes(x = pop, y = l, fill = pop)) + geom_boxplot() +
      labs(title = "Boxplots for Non-Paired Data Sets", x = "Data Set",y = "Distribution")

  } else {
    pop = rep("x", 30)
    data.frame(pop = pop,l= unlist(map2(df$x,df$y, function(a,b)a-b))) %>%
      ggplot(aes(x = pop, y = l, fill = pop)) + geom_boxplot() +
      geom_errorbar(aes(ymin = x$ci[[1]], ymax = x$ci[[2]],
                        width = 0, linewidth = .25)) +
      guides(linewidth = "none", fill = "none") +
      labs(title = "Boxplot of Differences", x = "x-y",y = "Distribution")
  }

  print(last_plot())
}
```

## Package in Action!
  
Below is an example of the package at work.
```{r}
set.seed(32); x=rnorm(30,mean=10,sd=15)
set.seed(35); y=rnorm(30,mean=8,sd=15)
ans1=DSA5041PROJ2::myttest(x,y,alpha=0.05,paired=FALSE)
print(ans1)
plot(ans1)

set.seed(32); x=rnorm(30,mean=10,sd=5)
set.seed(35); y=rnorm(30,mean=8,sd=15)
ans2=DSA5041PROJ2::myttest(x,y,alpha=0.05,paired=FALSE)
print(ans2)
plot(ans2)

set.seed(32); x=rnorm(30,mean=10,sd=15)
set.seed(35); y = x+ rnorm(30, 5 ,4)
ans3=DSA5041PROJ2::myttest(x,y,alpha=0.05,paired=TRUE)
print(ans3)
plot(ans3)
```
